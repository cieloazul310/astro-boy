---
import Layout from "../../layout/index.astro";
import Paper from "../../components/Paper.astro";
import PaperLink from "../../components/PaperLink.astro";
import Navigation from "../../components/Navigation.astro";
import MicrocmsCategories from "../../components/microcms/MicrocmsCategories.astro";
import Link from "../../components/Link.astro";
import Badge from "../../components/Badge.astro";
import { css } from "../../../styled-system/css";
import { hstack } from "../../../styled-system/patterns";
import {
  getBlogs,
  getBlogDetail,
  parseDate,
  rehypeIt,
  useNavigation,
  slugify,
  excerpt,
} from "../../utils";
import type { MicrocmsBlogs } from "../../types";

// 詳細記事ページの全パスを取得
export async function getStaticPaths() {
  const response = await getBlogs({ fields: ["id", "title", "publishedAt"] });
  return response.contents
    .sort(
      (a, b) =>
        new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime(),
    )
    .map((blog) => ({
      ...blog,
      slug: slugify("microcms", blog, true),
    }))
    .map(({ id, slug }, index, arr) => {
      const newer = index !== 0 ? arr[index - 1] : null;
      const older = index !== arr.length - 1 ? arr[index + 1] : null;

      return {
        params: {
          slug,
        },
        props: {
          blogId: id,
          newer,
          older,
        },
      };
    });
}

interface Props {
  year: string;
  month: string;
  blogId: string;
  newer:
    | (Pick<MicrocmsBlogs, "id" | "title" | "publishedAt"> & {
        slug: string;
      })
    | null;
  older:
    | (Pick<MicrocmsBlogs, "id" | "title" | "publishedAt"> & {
        slug: string;
      })
    | null;
}

const { blogId, newer, older } = Astro.props as Props;
const { title, publishedAt, content, category } = await getBlogDetail(
  blogId as string,
);

const html = await rehypeIt(content);
const navigation = useNavigation(
  { left: newer, right: older },
  {
    href: (obj) => `/microcms/${encodeURIComponent(obj.slug)}`,
    primaryText: (obj) => obj.title,
    secondaryText: (obj) => parseDate(obj.publishedAt),
  },
);
const description = excerpt(content);
---

<Layout title={title} description={description}>
  <Fragment slot="jumbotron-footer">
    <time datetime={parseDate(publishedAt)}>{parseDate(publishedAt)}</time>
  </Fragment>
  <Paper set:html={String(html)} />
  <Paper>
    <footer>
      <h2>{title}</h2>
      <p class={hstack({ gap: 2 })}>
        <time datetime={parseDate(publishedAt)}>{parseDate(publishedAt)}</time>
      </p>
      {
        category && (
          <p class={css({ mt: 1 })}>
            <Link
              href={`/microcms/categories/${encodeURIComponent(category.id)}`}
            >
              <Badge colorPalette="primary">{category.name}</Badge>
            </Link>
          </p>
        )
      }
    </footer>
  </Paper>
  <Navigation {...navigation} />
  <PaperLink href="/microcms/">CMS Posts Top</PaperLink>
  <Fragment slot="sidebar-top">
    <Navigation {...navigation} direction="column" />
    <MicrocmsCategories />
  </Fragment>
  <MicrocmsCategories slot="drawer-top" />
</Layout>
